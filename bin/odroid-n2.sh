#!/bin/bash
#
# Title: odroid-n2.sh
# Description: odroid n2 file system load
# Development Environment: ubuntu 22.04.5 LTS
# Author: Guy Cole (guycole at gmail dot com)
#
# run as root, all USB devices should be unmounted
#
PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin; export PATH
#
# Argument validation: require exactly two string arguments
if [[ $# -ne 2 ]]; then
    echo "Usage: ./odroid-n2.sh <source> <target> (e.g., /dev/sda /dev/sdb)"
    exit 1
fi
# Check both arguments are non-empty strings (not just whitespace)
if [[ -z "${1// }" || -z "${2// }" ]]; then
    echo "Error: Both arguments must be non-empty strings."
    exit 1
fi

boot_dev="${1}1"
root_dev="${1}2"
echo "boot device ${boot_dev}"
echo "root device ${root_dev}"
#
if [ $(id -u) -ne 0 ]; then
   echo "Error: must run as root"
   exit 1
fi
#
echo "start gateway copy"
#
SOURCE_DEV1="${1}1"
SOURCE_DEV2="${1}2"
TARGET_DEV1="${2}1"
TARGET_DEV2="${2}2"
#
SOURCE="/mnt/source"
TARGET="/mnt/target"
#
mount $SOURCE_DEV2 $SOURCE
mount $TARGET_DEV2 $TARGET
#
mkdir -p "${TARGET}/boot"
mount $TARGET_DEV1 "${TARGET}/boot"
#
mkdir -p "${SOURCE}/boot"
mount -o ro $SOURCE_DEV1 "${SOURCE}/boot"
#
rsync -aAXH --numeric-ids --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} "${SOURCE}/" "${TARGET}/"
#
rsync -aHv "${SOURCE}/boot/" "${TARGET}/boot/"
#
# fix fstab
#
BOOT_UUID=$(blkid -s UUID -o value $TARGET_DEV1)
ROOT_UUID=$(blkid -s UUID -o value $TARGET_DEV2)
#
echo "root uuid ${ROOT_UUID}"
echo "boot uuid ${BOOT_UUID}"
#
FILE_NAME=/mnt/target/etc/fstab
mv "${FILE_NAME}" "${FILE_NAME}.orig"
#
echo "# generated by odroid-n2.sh" > "${FILE_NAME}"
echo "UUID=${BOOT_UUID} /boot vfat defaults 0 2" >> "${FILE_NAME}"
echo "UUID=${ROOT_UUID} / ext4 defaults,noatime 0 1" >> "${FILE_NAME}"
#
# fix boot.ini
#
FILE_NAME=/mnt/target/boot/boot.ini
cp "${FILE_NAME}" "${FILE_NAME}.orig"
#
sed -i -E "s/root=UUID=[0-9a-fA-F-]+/root=UUID=${ROOT_UUID}/g" "${FILE_NAME}"
#
# cleanup
#
sync
umount "${SOURCE}/boot"
umount $SOURCE
umount "${TARGET}/boot"
umount $TARGET
sync
#
echo "end gateway copy"
#