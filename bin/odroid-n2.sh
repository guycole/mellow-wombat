#!/bin/bash
#
# Title: odroid-n2.sh
# Description: odroid n2 file system load
# Development Environment: 
# Author: Guy Cole (guycole at gmail dot com)
#
PATH=/bin:/usr/bin:/usr/sbin:/usr/local/bin; export PATH
#
#blkid="/usr/sbin/blkid"
#chroot="/usr/sbin/chroot"
#mkdir="/usr/bin/mkdir"
#mount="/usr/bin/mount"
#rsync="/usr/bin/rsync"
#uuidgen="/usr/bin/uuidgen"
#
device_src="/dev/sda"
boot_src="/dev/sda1" # vfat
root_src="/dev/sda2" # ext4
device_dst="/dev/sdb"
boot_dst="/dev/sdb1" # vfat
boot_dst_uuid="fixme"
root_dst="/dev/sdb2" # ext4
root_dst_uuid="fixme"
#
echo "start gateway copy"
#
mount /dev/sda2 /mnt/source
mount /dev/sdb2 /mnt/target
#
mkdir -p /mnt/target/boot
mount /dev/sdb1 /mnt/target/boot
#
mkdir -p /mnt/source/boot
mount -o ro /dev/sda1 /mnt/source/boot
#
rsync -aAXH --numeric-ids --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} /mnt/source/ /mnt/target/
#
rsync -aHv /mnt/source/boot/ /mnt/target/boot/
#
# fix fstab
#
BOOT_UUID=$(blkid -s UUID -o value /dev/sdb1)
ROOT_UUID=$(blkid -s UUID -o value /dev/sdb2)
#
echo "root uuid ${ROOT_UUID}"
echo "boot uuid ${BOOT_UUID}"
#
FILE_NAME=/mnt/target/etc/fstab
mv "${FILE_NAME}" "${FILE_NAME}.orig"
#
echo "# generated by odroid-n2.sh" > "${FILE_NAME}"
echo "UUID=${BOOT_UUID} /boot vfat defaults 0 2" >> "${FILE_NAME}"
echo "UUID=${ROOT_UUID} / ext4 defaults,noatime 0 1" >> "${FILE_NAME}"
#
FILE_NAME=/mnt/target/boot/boot.ini
cp "${FILE_NAME}" "${FILE_NAME}.orig"
#
sed -i -E "s/root=UUID=[0-9a-fA-F-]+/root=UUID=${ROOT_UUID}/g" "${FILE_NAME}"
#
echo "end gateway copy"
#
